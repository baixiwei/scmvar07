<!DOCTYPE html>
<html>

<head>

    <title>SCMVAR Experiment 7</title>

    <script type="text/javascript"          src="jquery-1.8.3.min.js"></script>
    <script type="text/javascript"          src="utility.js"></script>
    <script type="text/javascript"          src="content.js"></script>
    <link type="text/css" rel="stylesheet"  href="styles.css">

</head>

<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- disable the following when out of development: -->
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="-1">

<body>
	<div id="target"></div>
</body>

<script type="text/javascript">

var testing, offline;                               // controls whether/which database is accessed
var turk, accepted, sandbox;                        // whether on turk, and if so, whether HIT accepted, whether in sandbox
var hitId, assignmentId, workerId, turkSubmitTo;    // other information necessary for turk
var subjid, trial_data, table, exclude_tables;      // information needed regardless of whether on turk or not

// assign values to all the vars defined above
function setGlobalVars() {

    testing = true;         // change to false when going live

    turk = ( gup( "assignmentId" ) != "" );
    if ( turk ) {
        offline         = false;
        accepted        = ( gup( "assignmentId" )!="ASSIGNMENT_ID_NOT_AVAILABLE" );
        sandbox         = window.location.href.indexOf( "sandbox" ) != -1;
        hitId           = gup( "hitId" );
        assignmentId    = gup( "assignmentId" );
        workerId        = gup( "workerId" );
        turkSubmitTo    = gup( "turkSubmitTo" );
        subjid          = workerId;
    } else {
        offline         = true;        // change to false when going live
        subjid          = "NONTURK" + Math.floor(Math.random()*1000000000);
    }

    trial_data = {
        "turk": turk.toString(), "subjid": subjid,
        "localStorage": ( localStorage ? true : false ).toString(),
        "cookiesEnabled": are_cookies_enabled().toString() };
    if ( turk ) { $.extend( trial_data, {
        "turk": turk.toString(), "sandbox": sandbox.toString(),
        "hitId": hitId, "assignmentId": assignmentId, "workerId": workerId } );
    }
    console.log( "index.html > setGlobalVars. " + dataToString( trial_data ) );

    table   = "scmvar_07";
    if ( turk ) { table += "_turk"; }
    if ( testing ) { table += "_testing"; }
    exclude_tables = [ "scmvar_02_turk", "scmvar_03", "scmvar_04", "scmvar_04_turk", "scmvar_05", "scmvar_05b", "scmvar_05c" ];
    // some of the above may not have been run on turk, but I include them all just to be safe
    // the current experiment, scmvar_07, is NOT excluded because participants are allowed to do multiple HITs
    
    if ( turk ) {
        checkExclusion();
    } else {
        assignCondition();
    }
    
}

// turk only: check whether the worker is excluded due to previous participation in a related experiment
function checkExclusion() {
    if ( offline ) {
        assignCondition();
    } else {
        $.ajax( { type: 'post', cache: false, url: 'exclude_subject.php',
                  data: { 'subjid': subjid, 'tables': JSON.stringify(exclude_tables), 'table': table },
                  success: function(data) {
                    console.log( "index.html > checkExclusion succeeded, result: " + data.toString() );
                    if ( data==1 ) {
                        $('#target').html( '<p>Sorry, our records show that you have previously completed a related HIT for this requester.  Therefore, you are not eligible to do this HIT.  We apologize for the inconvenience.</p>' );
                    } else {
                        assignCondition();
                    }
                  },
                  error: function(data) {
                    console.log( "index.html > checkExclusion > error: " + data.toString() );
                    $('#target').html( '<p>The experiment failed to load for an unknown reason.  Unfortunately, you will be unable to complete this HIT.  We apologize for the inconvenience.</p>' ); 
                  } 
                  } );
    }
}

// assign condition, which determines which pair of questions will be shown on this trial
function assignCondition() {
    var numcond = 496;
    var condition;
    if ( turk ) {
        // if you are on turk, condition should be in the url
        condition = gup( "condition" );
        console.log( "index.html > assignCondition condition received from turk url: " + condition );
        assignParameters( condition );
    } else if ( offline ) {
        // if you are offline, determine a condition randomly
        condition = Math.floor( Math.random() * numcond );
        console.log( "index.html > assignCondition offline, so generated condition randomly: " + condition );
        assignParameters( condition );
    } else {
        // otherwise choose a condition to balance against those already in database
        $.ajax({ type: 'post', cache: false, url: 'assign_condition.php',
            data: { 'table': table, 'subjid': subjid, 'condition': condition, 'numcond': numcond },
            success: function(data) {
                condition = data;
                console.log( "index.html > assignCondition used database call, generated condition: " + condition );
                assignParameters( condition );
            },
            error: function(data) {
                condition = Math.floor( Math.random() * numsubcond );
                console.log( "index.html > assignCondition database call failed, generated subcondition: " + condition );
                assignParameters( condition );
            }});
    }
}

// assign parameters, which determine how the questions will be presented
function assignParameters( condition ) {
    var proceed = function( condition, parameters ) {
        console.log( "index.html > assignParameters. " + dataToString( parameters ) );
        trial_data = $.extend( trial_data, { "condition": condition }, parameters );
        doTrial( condition, parameters );
    }
    function getParameters( condition, callback ) {
        var parameters;
        if ( offline ) {
            // if we are working offline, parameters are generated randomly
            console.log( "index.html > getParameters offline, generating parameters randomly." );
            parameters = generateRandomParameters();
            callback( condition, parameters );
        } else if ( checkLocalStorage('condition',condition) ) {
            // params should only be in localStorage for this participant if we are in turk
            // the worker has previously previewed the HIT and has now accepted it
            // in this case, we recover the stored parameters instead of generating new ones, so the accepted HIT will be identical to the previewed one
            console.log( "index.html > getParameters retrieving parameters from local storage." );
            parameters = getLocalStorage( [ "subcondition", "question_order", "answer_order", "q1_order", "q1_base_num", "q1_exp_num", "q2_order", "q2_base_num", "q2_exp_num" ] );
            callback( condition, parameters );
        } else {
            // we are either not on turk or on turk and viewing the HIT for the first time
            // in either case, we consult the database in order to counterbalance parameter assignments within the given condition
            // we then save the 
            $.ajax( { type: 'post', cache: false, url: 'assign_parameters.php',
                data: { 'table': table, 'subjid': subjid, 'condition': condition },
                success: function( data ) {
                    console.log( "index.html > assignParameters generated parameters using database." );
                    parameters = JSON.parse( data );
                    setLocalStorage( $.extend( { 'condition': condition }, parameters ) );
                    callback( condition, parameters );
                    },
                error: function( data ) {
                    console.log( "index.html > assignParameters database access failed: " + data.statusText );
                    console.log( "index.html > assignParameters generated random parameters." );
                    parameters = generateRandomParameters();
                    setLocalStorage( $.extend( { 'condition': condition }, parameters ) );
                    callback( condition, parameters );
                } } );
        }
    }
    getParameters( condition, proceed );
}

// do the trial and submit data to the database
function doTrial( condition, parameters ) {

    var start_time = new Date();
        
    var displayTrial = function() {
        // create submission form and post it to target
        var content = '';
        content     += '<div id="trial"></div>';
        content     += '<form id="my_form" method="POST">';
        content     += '<p><input id="mTurkSubmitButton" type="submit" name="Submit" value=""></p>';
        content     += '</form>';
        $('#target').html( content );
        // set the submit button to appropriate text and action
        var submit_txt, live;
        if ( turk ) {
            submit_txt = accepted ?  "Submit HIT" : "You must click ACCEPT before you can do this HIT.";
            live = accepted;
        } else {
            submit_txt = "Submit";
            live = true;
        }   
        $('#mTurkSubmitButton').val( submit_txt );
        $('#mTurkSubmitButton').click( submitData );
        $('#mTurkSubmitButton').attr( "disabled", "disabled" );
        var on_select = function() { $('#mTurkSubmitButton').removeAttr( "disabled" ); }
        // display the trial
        displayTrialContent( $('#trial'), live, on_select, condition, parameters, trial_data );
    }
    
    var submitData = function(e) {
        // prevent from submitting the form by default
        e.preventDefault();
        // add start and end times and rt to data
        var end_time            = new Date();
        trial_data.start_time   = start_time.toString();
        trial_data.end_time     = end_time.toString();
        trial_data.rt           = end_time.getTime() - start_time.getTime();
        if ( offline || (!turk) ) {
            // if offline, or not on turk, just display the data
            // if you ever run this outside of turk for real, you'll want something different to happen here.
            $('#target').html( JSON.stringify(trial_data) );
        } else {
            // submit data to our database, then to turk
            $.ajax( { type: 'post',
                      cache: false,
                      url: 'submit_data_row.php',
                      data: { 
                        'table': table,
                        'json': JSON.stringify(trial_data) },
                      success: function(d) {
                        console.log( "submitData succeeded with result: " + d );
                        submitHIT();
                      },
                      error: function(d) {
                        console.log( "submitData failed with error " + d.statusText );
                        submitHIT();
                      }
                    } );
        }
    }
    
    displayTrial();
    
}

// submit data to mechanical turk
var submitHIT = function() {
    // remove data from local storage, if applicable, so this participant can do more HITs
    clearLocalStorage( [ "condition", "subcondition", "question_order", "answer_order", "q1_order", "q1_base_num", "q1_exp_num", "q2_order", "q2_base_num", "q2_exp_num" ] );
    // add data as hidden fields to the form so these will submit to turk
    // NOTE: assignmentId must be included here so Turk will recognize the completed assignment
    for ( key in trial_data ) {
        $('#my_form').append( '<input type="hidden" id="' + key + '" name="' + key + '" value="">' );
        $('#'+key).val( trial_data[key] );
    }
    console.log( "submitHIT assignmentId: " + $('#assignmentId').val() );
    // submit the form to Turk
    var action = sandbox ?
        "https://workersandbox.mturk.com/mturk/externalSubmit" :
        "https://www.mturk.com/mturk/externalSubmit";
    $('#my_form').attr( "action", action );
    $('#my_form').submit();
}

setGlobalVars();

</script>
</html>
