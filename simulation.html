<!DOCTYPE html>
<html>

<head>

    <title>SCMVAR Experiment 7b</title>

    <script type="text/javascript"          src="jquery-1.8.3.min.js"></script>
    <script type="text/javascript"          src="utility.js"></script>
    <script type="text/javascript"          src="jspsych-revised.js"></script>
    <script type="text/javascript"          src="button_choice.js"></script>
    <script type="text/javascript"          src="experiment.js"></script>
    <link type="text/css" rel="stylesheet"  href="styles.css">

</head>

<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- disable the following when out of development: -->
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="-1">

<body>
	<div id="target"></div>
</body>

<script type="text/javascript">

var table = 'scmvar_07b_testing';

function doSubject( subjid, callback ) {
    $.ajax({ type: 'post', cache: false, url: 'assign_cond_subcond.php',
        data: { 'table': table, 'subjid': subjid, 'numcond': 2556, 'numsubcond': 8, 'trialspersubj': 10 },
        success: function(data) {
            callback( $.parseJSON( data ) );
        },
        error: function(data) {
            $('#target').html( "Failure" );
        }
        });
}

function doRepetition( subjids, callback ) {
    var subj_data   = [];
    var subj_idx    = 0;
    var iterate = function( assignments ) {
        // add subject data to list and increment subject index
        for ( var i=0; i<assignments.length; i++ ) {
            subj_data.push( $.extend( { "subjid": subjids[subj_idx] }, assignments[i], { "approve": 1 } ) );
        }
        subj_idx++;
        // if there are subjects remaining, do another, otherwise return the result of the repetition
        if ( subj_idx<subjids.length ) {
            doSubject( subjids[subj_idx], iterate );
        } else {
            callback( subj_data );
        }
    }
    doSubject( subjids, iterate );
}

function doRound( num_subjs, num_repetitions, callback ) {
    var subjids = [];
    for ( var i=0; i<num_subjs; i++ ) {
        subjids.push( "subj_" + Math.floor( Math.random()*1000000000 ) );
    }
    var rep_idx = 0;
    var iterate = function( subj_data ) {
        // record data to database
        $.ajax( { type: 'post',
                  cache: false,
                  url: 'submit_data.php',
                  data: { 
                    'table': table,
                    'json': JSON.stringify([subj_data]) },
                  success: function(data) {
                    // if there are repetitions remaining, do another, otherwise callback
                    rep_idx++;
                    if ( rep_idx<num_repetitions ) {
                        doRepetition( subjids, iterate );
                    } else {
                        callback();
                    }
                  },
                  error: function(data) {
                    console.log( "doRound failed with error " + data.statusText );
                  }
                } );
        
    }
    doRepetition( subjids, iterate );
}

function doSimulation( num_rounds, num_subjs, num_repetitions ) {
    var i=0;
    var iterate = function() {
        i++;
        if ( i<num_rounds ) {
            doRound( num_subjs, num_repetitions, iterate );
        } else {
            $('#target').append( "Finished simulation." );
        }
    }
    doRound( num_subjs, num_repetitions, iterate );
}

// Let's say we want 16 completes per condition, i.e. 40,896 completes
// Let's assume average 100 completes per subject, i.e. 10 repetitions @ 10 trials per repetition
// Let's assume 10 subjects working simultaneously
// That means each round we finish 10 subjects * 100 completes per subject = 1000 completes
// So at a minimum we need 40.896 rounds.
// Let's assume we need 5% overkill - that's about 43 rounds.
// Here we go:

doSimulation( 43, 10, 10 );

</script>
</html>
